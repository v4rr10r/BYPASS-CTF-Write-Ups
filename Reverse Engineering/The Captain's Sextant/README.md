# The Captain's Sextant - BYPASS CTF 

## Challenge Information

| Field | Value |
|-------|-------|
| **CTF** | BYPASS CTF |
| **Category** | Rev |
| **Difficulty** | Hard |
| **Points** | 400 |


## Description

> "The stars guide the way, but only for those who know the rhythm of the ocean."
>
> You have found an old navigational simulator used by the Pirate Lord to train his navigators.
> Legend says the Lord hid the coordinates to his stash inside the simulation itself.
> But it only reveals itself to those with perfect intuition.
>
> Align the sextant. Follow the stars.
> But remember: The game knows when you are guessing.

**Files provided:**
- `captains_sextant` â€” ELF executable

**Flag format:** `BYPASS_CTF{.*}`

---

## TL;DR

The SDL game shows a fake flag after winning. The real flag is silently generated using hidden logic involving PRNG and XOR. Recreating this logic offline reveals the actual flag.

**Vulnerability:** Hidden flag generation not connected to gameplay  
**Approach:** Static reverse engineering + offline reconstruction

---

## Initial Analysis

### Binary Reconnaissance

- ELF binary using SDL
- Gameplay revolves around rotating an arm to align angles
- Winning prints `FAKE_VICTORY_FLAG`, indicating a decoy

---

## Reverse Engineering

### Suspicious Function

```c
char align_star(int index,int timing_key)

{
  int timing_key_local;
  int index_local;
  char c;
  uint k;
  int i;
  int k_byte;
  
  k = 0x1337b0a7;
  for (i = 0; i < index; i = i + 1) {
    k = k * 0x41c64e6d + 0x3039 & 0x7fffffff;
  }
  return (byte)(k >> ((byte)index & 3)) ^ (byte)timing_key;
}
```
**Observations:**

- Unrelated to rendering or input
- Returns one byte
- Uses PRNG and XOR
- Typical flag-generation pattern
- Input Handling Logic
- Inside process_input_event():
- Each key press increments input_count
- Index calculated as index = input_count % 44
- Flag byte computed as:   
align_star(index, g_star_timings[index])

#### Key findings:

- Flag length = 44
- g_star_timings[44] is a static array
- Timing/gameplay is a red herring
- Generated bytes are never shown in-game

## Exploitation

1. Extract align_star() logic
2. Dump g_star_timings[44]

Assemble bytes into flag

``` python 
The Captain's Sextant
g_star_timings = [
    0xE5,0xF3,0x6F,0x7F,
    0x10,0x33,0xA1,0x24,
    0xCB,0x30,0xD6,0xFD,
    0x8A,0x81,0x7D,0xEC,
    0xF0,0x9D,0xEA,0x07,
    0x6C,0xBD,0x2C,0xCE,
    0xFD,0xF7,0xBD,0xF7,
    0x9A,0xEA,0x4F,0x87,
    0xCE,0xB4,0x28,0x7E,
    0x4B,0xA3,0xE9,0x45,
    0x4F,0x97,0x81,0x68
]

def align_star(index, timing_key):
    k = 0x1337b0a7
    for _ in range(index):
        k = (k * 0x41c64e6d + 0x3039) & 0x7fffffff
    return ((k >> (index & 3)) & 0xff) ^ timing_key

flag = "".join(chr(align_star(i, g_star_timings[i])) for i in range(44))
print(flag)
```

## Flag

`BYPASS_CTF{T1m1ng_1s_Ev3ryth1ng_In_Th3_V01d}`

pwn by **W4RR1OR**